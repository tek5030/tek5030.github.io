<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lab 11: Step 2: Finish `MultivariateNormalModel`</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Lab 11
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Step 2: Finish `MultivariateNormalModel` </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>First, take a look at the definition and documentation in <a href="../multivariate_normal_model.h">multivariate_normal_model.h</a>. Then go to <a href="../multivariate_normal_model.cpp">multivariate_normal_model.cpp</a>. Read through the code to get an overview of the class.</p>
<h2>1. Implement the method <code>performTraining()</code> in <code><a class="el" href="classMultivariateNormalModel.html" title="A class that stores a trained multivariate normal model. ">MultivariateNormalModel</a></code></h2>
<p>The multivariate normal distribution for a dataset of vectors <b>x</b> is characterized by a mean vector <b>&mu;</b> and a covariance matrix <b>&Sigma;</b>.</p>
<p>![{N}({}, {}) = {1}{ (2)^{{k}{2}} |{}|^{{1}{2}}} [-{1}{2}({} - {x})^{T}{}^{-1} ({} - {x}) ]](img/multivariate_normal_distribution.png)</p>
<p>Given such a distribution, the Mahalanobis distance between a vector <b>x</b> and the distribution is a measure for how well the vector fits with the distribution.</p>
<div class="image">
<img src="img/mahalanobis_distance.png" alt="\mathit{d}_{\mathit{M}}(\mathbf{x}) = \sqrt{(\mathbf{x}-\boldsymbol{\mu})^{T} \boldsymbol{\Sigma}^{-1} 
(\mathbf{x} - \boldsymbol{\mu})}"/>
</div>
<p>The method <code><a class="el" href="classMultivariateNormalModel.html#ad0e9895b27cd1edb6a193bb0ac424880" title="Create a model given some training samples. ">MultivariateNormalModel::performTraining</a></code> should estimate the mean <code>mu_</code> and inverse covariance matrix <code>inv_covar_</code> for the model based on the training samples <code>samples_</code> collected from the sampling region.</p>
<p>In its current state, the method simply returns <b>mu_ = 1</b> and <b>inv_covar_ = Identity</b>. You should replace this with the correct computations.</p>
<p>Take a look at <a href="https://docs.opencv.org/4.0.1/d2/de8/group__core__array.html#ga017122d912af19d7d0d2cccc2d63819f">cv::calcCovarMatrix</a>. We want <code>mu_</code> to be a column vector. The flags in <code><a class="elRef" doxygen="/home/rsm/dev/tek5030/2021/tek5030.github.io/doxygen-tags/opencv.tag:http://docs.opencv.org/4.0.1/" href="http://docs.opencv.org/4.0.1/d2/de8/group__core__array.html#gae6ffa9354633f984246945d52823165d">cv::calcCovarMatrix()</a></code> can be combined like this: <code>flag1|flag2</code>.</p>
<h2>2. Implement the method <code>computeMahalanobisDistances</code> in <code><a class="el" href="classMultivariateNormalModel.html" title="A class that stores a trained multivariate normal model. ">MultivariateNormalModel</a></code></h2>
<p>This method should compute the Mahalanobis distance between every pixel in the input image and the estimated multivariate normal model described by <code>mu_</code> and <code>sigma_inv_</code>.</p>
<div class="image">
<img src="img/mahalanobis_distance.png" alt="\mathit{d}_{\mathit{M}}(\mathbf{x}) = \sqrt{(\mathbf{x}-\boldsymbol{\mu})^{T} \boldsymbol{\Sigma}^{-1} 
(\mathbf{x} - \boldsymbol{\mu})}"/>
</div>
<p>The method should return a <a class="elRef" doxygen="/home/rsm/dev/tek5030/2021/tek5030.github.io/doxygen-tags/opencv.tag:http://docs.opencv.org/4.0.1/" href="http://docs.opencv.org/4.0.1/d3/d63/classcv_1_1Mat.html">cv::Mat</a> of Mahalanobis distances, but in its current state it simply returns a matrix of 0.5's. You should replace this with a proper implementation.</p>
<p>Take a look at <a href="https://docs.opencv.org/4.0.1/d2/de8/group__core__array.html#ga4493aee129179459cbfc6064f051aa7d">cv::Mahalanobis</a>.</p>
<h2>3. Implement the method <code>computeTransformedMahalanobisImage</code> in <code><a class="el" href="classMultivariateNormalModel.html" title="A class that stores a trained multivariate normal model. ">MultivariateNormalModel</a></code></h2>
<p>Although we could perform segmentation based on the Mahalanobis distances directly, we would like to transform it into the range [0,1] which is better suited for visualization.</p>
<p>One way of doing this is to transform the image like this:</p>
<div class="image">
<img src="img/transformed_mahalanobis_distance.png" alt="D_{M}(\mathbf{x}) = \exp \left(-s \cdot d_{M}(\mathbf{x}) \right),s\in\mathbb{R}_{+}"/>
</div>
<p>This transformation ensures that we get values in the range of [0,1] which is what we want. It also flips the ordering such that low Mahalanobis distances ends up in the vicinity of 1, while large Mahalanobis distances ends up closer to 0. Hence, the pixels that fit well with the distribution will be bright in our visualization while those that clearly do not fit will be dark. The thresholding will segment out the pixels corresponding to the brightest pixels in our transformed Mahalanobis image.</p>
<p>The positive constant <b>s</b> in the transformation, can be chosen according to how we want the contrast to behave.</p>
<div class="image">
<img src="img/transformation_family.png" alt="rescale_constants"/>
</div>
<p>We suggest that you set <em>s = 2</em> to enhance the contrast in the lower range of Mahalanobis distances. But feel free to test other values of <b>s</b> to get a transformed Mahalanobis image that works well for your setup.</p>
<p>In its current version, this method simply returns a matrix of 1's. You should replace this with the matrix of properly transformed Mahalanobis distances.</p>
<p>Take a look at <a href="https://docs.opencv.org/4.0.1/d2/de8/group__core__array.html#ga3e10108e2162c338f1b848af619f39e5">cv::exp()</a>.</p>
<h2>4. Implement the method <code>update</code> in <code><a class="el" href="classMultivariateNormalModel.html" title="A class that stores a trained multivariate normal model. ">MultivariateNormalModel</a></code></h2>
<p>This method should update the multivariate normal model by replacing a fraction of the existing <code>samples_</code> with some <code>new_samples</code> and then retrain the model.</p>
<p>This should make the model gradually change over time and we should be able to control the rate of which it changes by adjusting the <code>update_ratio</code>.</p>
<p>The <code>update_ratio</code> should be a number between 0 and 1, where 0.1 means that a random 10% of <code>samples_</code> are being replaced with new one each iteration.</p>
<p>Keypress <b>a</b> activates/deactivates the adaptive model.</p>
<p>In its current state, this method does not change <code>samples_</code> at all. Your job is to implement this method so that i works as intended.</p>
<p><b>Suggestion 1:</b> You can for instance use [<a class="elRef" doxygen="/home/rsm/dev/tek5030/2021/tek5030.github.io/doxygen-tags/opencv.tag:http://docs.opencv.org/4.0.1/" href="http://docs.opencv.org/4.0.1/d2/de8/group__core__array.html#ga1ba1026dca0807b27057ba6a49d258c0">cv::randu</a>]() to generate a matrix of random numbers between 0 and 1 with the same number of columns as <code>samples_</code>. Loop through the columns and replace columns if their random number is smaller than the <code>update_ratio</code>.</p>
<p><b>Suggestion 2:</b> Another approach is to make use of [<a class="elRef" doxygen="/home/rsm/dev/tek5030/2021/tek5030.github.io/doxygen-tags/opencv.tag:http://docs.opencv.org/4.0.1/" href="http://docs.opencv.org/4.0.1/d2/de8/group__core__array.html#ga6a789c8a5cb56c6dd62506179808f763">cv::randShuffle</a>](). By first shuffling both <code>samples_</code> and <code>new_samples</code> you can update the first N columns of <code>samples_</code> with the first N columns of <code>new_samples</code>. Here N should be determined based on the <code>update_ratio</code>.</p>
<p>How does this adaptive model work? Try adjusting the <code>update_ratio</code>. Are the changes noticeable?</p>
<p>Please continue to the <a class="el" href="3-further-work_8md.html">3-further-work.md</a> "next step". </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Feb 1 2021 10:48:52 for Lab 11 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
